WeChatミニプログラムデモアプリ要件書
1. システム概要
1.1 目的
複数のエージェントがサーバー上の素材を利用し、カスタマイズしてサーバーにアップロード。
サーバー側でアップロード内容を審査し、承認された場合、クライアントに特別なQRコード画像を送信。
WeChatミニプログラムの機能をシミュレートし、Ubuntu環境でのデモアプリとして動作させる。
1.2 ターゲットユーザー
開発者：WeChatミニプログラムのデモアプリをテスト・開発するエンジニア。
エージェント：素材をカスタマイズ・アップロードし、審査とQRコードを受領するユーザー。
2. システム構成
2.1 ファイル構成
システムは以下のディレクトリ構造で構成されます：
サーバー側 (~/Projects2/server)
server.py: Flaskを使用したバックエンドAPIで、素材の管理、アップロード、ダウンロード、審査処理、QRコード配信を提供。
materials.json: サーバー上の素材（写真、テキスト）のメタデータを保存。
data/: 実際の素材ファイル（画像やテキスト）やアップロードされたキャプチャー画面、QRコード画像を保存。
例: sample_image.jpg, sample_text.txt
クライアント側 (~/Projects2/client)
index.html: Webベースのユーザーインターフェースを提供（素材リスト表示、ダウンロード、アップロード、QRコード受領）。
script.js: クライアント側のJavaScriptロジック（サーバーAPI呼び出し、UI操作、カスタマイズ機能）。
2.2 動作環境
OS: Ubuntu（最新安定版）
Python: 3.x（Flaskと必要なライブラリをサポート）
Webサーバー: PythonのシンプルHTTPサーバー（python -m http.server）または同様の軽量Webサーバー
ブラウザ: 最新のChrome、Firefox、Edgeなど
3. 機能要件
3.1 クライアント機能
3.1.1 素材の参照・ダウンロード
クライアントはサーバー上の素材（写真とテキスト）をリスト形式で表示し、選択してダウンロード可能。
入力: 素材リストの選択（IDまたは名前）。
出力: 選択した素材（画像やテキストファイル）をローカルにダウンロード。
仕様: サーバーからJSON形式で素材リストを取得（GET /materials）、個別素材をダウンロード（GET /materials/<id>）。
3.1.2 素材のカスタマイズ
ダウンロードした素材をクライアント上でカスタマイズ可能。
画像: HTML5キャンバスを使用してテキストを追加、トリミング、サイズ変更。
テキスト: テキストエリアで編集。
仕様: キャンバスやテキストエリアで編集後、編集内容を保持。
3.1.3 素材以外のアップロード（キャプチャー画面、URL、テキストコメント）
クライアントはサーバーの特定フォルダ（例: data/uploads/）に以下のデータをアップロード可能：
キャプチャー画面（スクリーンショット画像）。
URL（文字列形式）。
テキストコメント（自由記述）。
入力: 画像ファイル、URL入力フィールド、テキストエリア。
出力: アップロードデータをサーバーに送信（POST /uploads）。
仕様: アップロードデータは審査待ち状態としてサーバーに保存。
3.1.4 QRコードの受領
サーバー側の審査が完了し、承認された場合、クライアントは特別なQRコード画像を受領可能。
入力: サーバーからの通知（例: WebSocketまたはポーリングによる）。
出力: QRコード画像（JPEG/PNG形式）をダウンロード。
仕様: サーバーからGET /qr/<id>でQRコードを取得。
3.2 サーバー機能
3.2.1 素材管理
サーバーは素材（写真、テキスト）を管理し、クライアントからのリクエストに応答。
仕様: 
GET /materials: 素材リストをJSON形式で返す。
GET /materials/<id>: 特定素材をファイル形式で返す。
POST /materials: 新規素材を保存。
3.2.2 アップロードデータの管理
サーバーはキャプチャー画面、URL、テキストコメントを特定フォルダ（data/uploads/）に保存し、審査待ち状態に設定。
仕様: 
POST /uploads: アップロードデータを保存（画像、URL、テキストをJSONで管理）。
審査ステータスを管理（初期値: pending、承認後: approved、否認後: rejected）。
3.2.3 審査処理
サーバー管理者がコマンド操作でアップロードデータを審査。
入力: 管理者の手動操作（例: 管理ツールまたはスクリプト）。
出力: 審査結果をデータベース（またはJSON）に反映。
仕様: 審査が「OK」の場合、特別なQRコードを生成し、data/qr/に保存。
3.2.4 QRコード生成・配信
審査通過後、サーバーはQRコード画像を生成し、クライアントに配信。
仕様: 
GET /qr/<id>: 特定IDのQRコード画像を返す。
QRコードはランダムなユニークIDをベースに生成（例: qrcode_<id>.png）。
3.3 エージェントの運用
複数のエージェントがクライアントを利用し、以下のワークフローを実行：
サーバーの素材を参照・ダウンロード。
素材をカスタマイズ。
カスタマイズした素材をサーバーにアップロード。
サーバー側の審査を待つ。
審査が「OK」の場合、QRコードを受領。
4. 技術要件
4.1 サーバー側
言語/フレームワーク: Python 3.x、Flask
ライブラリ:
flask, flask-cors（CORS対応）
qrcode（QRコード生成、必要に応じてインストール）
ストレージ:
ファイルシステム（data/ディレクトリ）
JSONファイル（materials.json、uploads.jsonなど）
API:
RESTful API（GET/POST対応）
エラーハンドリング（404、500などのHTTPステータス）
4.2 クライアント側
言語/フレームワーク: HTML5、JavaScript（ES6+）
UI:
レスポンシブデザイン（簡易）
HTML5キャンバス（画像編集）
テキストエリア（テキスト編集）
API通信:
fetch APIを使用したサーバー通信
CORS対応（ブラウザでの制限を考慮）
4.3 セキュリティ
基本認証またはトークンベース認証（エージェントごとのアクセス制限）
アップロードファイルのバリデーション（サイズ、形式）
CORS設定によるアクセス制御
5. 動作確認手順
5.1 サーバー起動
~/Projects2/server ディレクトリに移動。
必要なライブラリをインストール：
bash
pip install flask flask-cors qrcode
python server.py を実行（ポート8080で起動）。
5.2 クライアント起動
~/Projects2/client ディレクトリに移動。
python -m http.server 8000 を実行（ポート8000で起動）。
ブラウザで http://localhost:8000/index.html を開く。
5.3 テスト手順
素材リストが表示されることを確認（GET /materials）。
素材をダウンロード・編集・ダウンロード可能かを確認。
キャプチャー画面、URL、テキストコメントをアップロードし、サーバーに保存されることを確認（POST /uploads）。
サーバー側で審査を実施し、QRコードが生成・配信されることを確認（GET /qr/<id>）。
6. 制限事項
サーバーのストレージはファイルシステムに依存するため、大規模なデータには適さない。
審査は手動操作に依存するため、自動化が必要な場合は追加開発が必要。
CORS設定や認証は基本的なものであり、セキュリティ要件が厳しい場合は強化が必要。
7. 参考資料
WeChatミニプログラム公式ドキュメント: https://developers.weixin.qq.com/miniprogram/en/dev/
Flaskドキュメント: https://flask.palletsprojects.com/
QRコード生成ライブラリ: https://pypi.org/project/qrcode/